<!DOCTYPE html>
<title>Bad Apple Preview</title>
<h1>Bad Apple Preview</h1>
<canvas style="width: 256px; image-rendering: pixelated;"></canvas>
<button onclick="onInit()">Play</button>
<input type="text" readonly style="width: 256px;">
<script type="module">
	const optionsRes = await fetch('./frames/options.txt');
	const options = await optionsRes.text();
	const [width, height, fps] = options.split('\n');

	const dataRes = await fetch('./frames/out/frames.bin');
	const data = await dataRes.arrayBuffer();
	const frames = new Uint8Array(data);
	let index = 0;
	let frame = 0;

	const canvas = document.querySelector('canvas');
	canvas.width = width;
	canvas.height = height;

	const ctx = canvas.getContext('2d');
	const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
	const statField = document.querySelector('input');
	let interval;

	globalThis.onFrame = onFrame;
	globalThis.onInit = onInit;

	function setPixel (index, active) {
		img.data[index * 4] = active ? 255 : 0;
		img.data[index * 4 + 1] = active ? 255 : 0;
		img.data[index * 4 + 2] = active ? 255 : 0;
		img.data[index * 4 + 3] = 255;
	}

	function onFrame () {
		if (index >= frames.length) {
			document.querySelector('button').hidden = false;
			clearInterval(interval);
			return;
		}

		const end = frames[index++] + frames[index++] * 256 + index;

		let active = false;
		let pixelIndex = 0;

		for (; index < end; index++) {
			for (let i = frames[index]; i > 0; i--) {
				setPixel(pixelIndex++, active);
			}

			active = !active;
		}

		frame++;
		statField.value = `${frame.toString().padStart(4, '0')}: ${index}/${frames.length} (${(index / frames.length * 100).toFixed(2)})%`;
		ctx.putImageData(img, 0, 0);
	}

	function onInit () {
		document.querySelector('button').hidden = true;
		index = 0;
		frame = 0;
		interval = setInterval('onFrame();', 1000 / fps);
	}
</script>
